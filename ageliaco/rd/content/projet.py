# -*- coding: UTF-8 -*-
canvas = """
<p><i>Enlever les parties de texte pas nécessaires</i></p>
<H3 CLASS="western">Objectifs et retombées attendues du projet</H3>
<H4 CLASS="western"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Quels
sont les objectifs du projet ? Liste des changements concrets
auxquels il est raisonnable de s'attendre à l'issue de la recherche,
mais également à long terme (indicateurs de changement, outils
d'évaluation)</B></FONT></FONT></FONT></H4>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-weight: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">Les
objectifs sont exprimés en termes d'actions à mener ou de
changements auxquels on peut raisonnablement s'attendre à l'issue de
la recherche.</FONT></FONT></FONT></P>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-weight: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">Ils
doivent être réalistes, mais liés à un résultat tangible tout en
tenant compte des différentes contraintes, le temps et les moyens à
disposition, par exemple, ou encore les difficultés prévisibles que
l'on rencontrera pour les atteindre et les faire atteindre par
d'autres</FONT></FONT></FONT></P>
<H4 CLASS="western"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Bénéficiaires
de ces changements (retombées pour les maîtres et les élèves)</B></FONT></FONT></FONT></H4>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><SPAN STYLE="font-weight: normal">Implantation
et diffusion du projet (modalités prévues pour la diffusion et
l'implantation du produit, de l'expérience)</SPAN></FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt"><I><B>.
</B></I></FONT></FONT></FONT><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><SPAN STYLE="font-style: normal"><SPAN STYLE="font-weight: normal">Il
s'agit aussi d'essayer de prévoir quels résultats concrets et
quelles autres implications, locales ou générales, la réalisa-
tion des objectifs pourrait entraîner à court et long terme, dans
d'autres domaines, sur d'autres plans.</SPAN></SPAN></FONT></FONT></FONT></P>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">On
peut imaginer, par exemple, que l'utilisation de tel didacticiel
réclamera la modification des conditions d'accès au matériel
informatique ou l'adaptation de la politique d'équipement en la
matière.</FONT></FONT></FONT></P>
<H3 CLASS="western">Problématique et contexte</H3>
<H4 CLASS="western" STYLE="font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Quels
éléments de la situation présente sont à l'origine du besoin
exprimé et justifient l'existence du pro- jet ? Preuve du besoin :
étude, enquête, sondage, argumentaire précis, etc.</B></FONT></FONT></FONT></H4>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">L'exposé
de ces motifs est un élément capital pour plusieurs raisons :</FONT></FONT></FONT></P>
<UL>
	<LI><P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
	<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">définition
	du point de départ que constitue la situation actuelle, il permet
	d'apprécier la distance à couvrir pour atteindre les objectifs (la
	connaissance d'études menées dans le domaine considéré apporte,
	le cas échéant, une précision supplémentaire);</FONT></FONT></FONT></P>
	<LI><P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
	<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">il
	constitue une justification de l'action à entreprendre dans la
	mesure où il met en évidence et définit un besoin réel, montre
	que ce besoin est largement partagé et laisse supposer, par
	conséquent, que la diffusion pourra se développer dans des
	conditions favorables.</FONT></FONT></FONT></P>
	<LI><P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
	<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">le
	simple constat d'une nécessité ne semble pas suffisant. Par
	exemple, la création d'un site qui devrait être réalisé parce
	qu' &quot;il pourra être utilisé par des élèves, des maîtres...
	&quot;, sur simple conviction personnelle est un motif insuffisant.
	Peut-être faut-il concevoir une enquête sur la forme, le contenu,
	l'utilisation ou la nécessité du projet auprès des futurs
	utilisateurs, cela avant même d'en élaborer la forme exacte</FONT></FONT></FONT></P>
</UL>
<H4 CLASS="western" STYLE="font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Quelles
personnes partagent les préoccupations des auteurs, ressentent le
même besoin et seraient réellement intéressées par
l'aboutissement de cette recherche ? (Sujet intéressant plus d'un
établissement ou plus d'un centre de concertation, priorité
institutionnelle, lien avec une innovation, contacts pris avec un ou
des groupes de discipline, avec des personnes extérieures à
l'institution, etc.).</B></FONT></FONT></FONT></H4>
<H3 CLASS="western">Nature du projet</H3>
<H4 CLASS="western" STYLE="font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Type
et originalité du projet (création d'un produit, évaluation d'une
expérience, résolution de problèmes pédagogiques, développement
d'initiatives locales, etc.)</B></FONT></FONT></FONT></H4>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">Caractéristiques
du projet ou des apports prévus (maquette, plan détaillé,
prototype, etc.)</FONT></FONT></FONT></P>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">Cette
partie doit être à la fois concise et précise: la &quot;nature&quot;
doit faire apparaître le genre de recherche proposée. Il convient
de donner une description aussi précise et complète des buts du
projet.</FONT></FONT></FONT></P>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">Si
le projet vise la réalisation d'un produit, il importe que les
auteurs s'efforcent d'imaginer des &quot;produits ouverts&quot; que
les utilisateurs pourront améliorer et enrichir au gré de leurs
besoins et qui seront suffisamment flexibles pour s'adap- ter à
différents types d'utilisation. Pour favoriser la diffusion, il
conviendra non seulement de prévoir des supports maté- riels
commodes et attrayants, mais aussi d'accompagner le produit lui-même
de toutes les indications facilitant son emploi (descriptif,
résultats de l'expérimentation, suggestions d'utilisation, par
exemple).</FONT></FONT></FONT></P>
<H4 CLASS="western" STYLE="font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Connaissances
et expériences préalables </B></FONT></FONT></FONT>
</H4>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">Travail
préalable et réflexion déjà entamée dans le domaine de recherche
proposé : bibliographie, inventaire éventuel</FONT></FONT></FONT></P>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">d'expériences
semblables, de sites existants, de matériel comparable, etc.</FONT></FONT></FONT></P>
<H3 CLASS="western">Constitution de l'équipe et répartition des
tâches</H3>
<UL>
	<UL>
		<UL>
			<UL>
				<LI><H4 CLASS="western" STYLE="font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Constitution
				de l'équipe membres provenant de différents établissements, de
				différents ordres d'ensei- gnement - recherche de collaborations
				ou de personnes de référence autour des différents pôles du
				travail - diagramme de répartition des responsabilités au sein
				du groupe</B></FONT></FONT></FONT></H4>
			</UL>
		</UL>
	</UL>
</UL>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">Sans
une adhésion minimale de l'équipe, le projet ne peut aboutir, et
cela même si l'on bénéficie de l'appui d'autres acteurs et des
ressources nécessaires pour sa mise en œuvre. Ce degré d'adhésion
peut être obtenu à condition qu'il y ait une véritable démarche
d'équipe permettant l'appropriation par chacun de la problématique
du projet (construction d'une représentation commune).</FONT></FONT></FONT></P>
<UL>
	<UL>
		<UL>
			<UL>
				<LI><H4 CLASS="western" STYLE="font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Regard
				extérieur - validation scientifique</B></FONT></FONT></FONT></H4>
			</UL>
		</UL>
	</UL>
</UL>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt"><B>Planification
et ressources</B></FONT></FONT></FONT></P>
<UL>
	<LI><P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Nombre
	d'années de travail prévu, nombre d'heures demandées
	(justification précise)</B></FONT></FONT></FONT></P>
</UL>
<P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal; font-weight: normal">
<FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt">La
planification demeure indispensable puisqu'elle fait apparaître
l'ensemble des relations entre les actions prévues. Elle peut subir
des adaptations en fonction de l'évolution du projet.</FONT></FONT></FONT></P>
<UL>
	<LI><P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Autres
	ressources demandées par maître ou appui technique demandé</B></FONT></FONT></FONT></P>
	<LI><P ALIGN=LEFT STYLE="margin-bottom: 0cm; font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>Organisation
	du travail - planification du travail (étapes clés avec :
	objectifs spécifiques, traces ou indicateur de réalisation, temps
	de travail prévu </B></FONT></FONT></FONT>
	</P>
</UL>
<H3 CLASS="western" STYLE="font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt"><B>Moyens</B></FONT></FONT></FONT></H3>
<H4 CLASS="western" STYLE="font-style: normal"><FONT COLOR="#000000"><FONT FACE="Helvetica, sans-serif"><FONT SIZE=2 STYLE="font-size: 9pt"><B>C'est
seulement de manière progressive que l'on parviendra à les
identifier de manière précise, après avoir défini les actions,
trouvé des collaborateurs et pris les contacts indispensables.</B></FONT></FONT></FONT></H4>
"""


from five import grok
from zope import schema
from plone.namedfile import field as namedfile
from z3c.relationfield.schema import RelationChoice, RelationList
from plone.formwidget.contenttree import ObjPathSourceBinder

from plone.directives import form, dexterity
from zope.security import checkPermission

from ageliaco.rd import _

# for debug purpose => log(...)
from Products.CMFPlone.utils import log

from plone.app.textfield import RichText
#from plone.app.z3cform.wysiwyg import WysiwygFieldWidget
from zope.lifecycleevent.interfaces import IObjectModifiedEvent

import datetime

from zope.schema.interfaces import IContextSourceBinder
from zope.schema.vocabulary import SimpleVocabulary
from zope.app.container.interfaces import IObjectAddedEvent
from Products.CMFCore.utils import getToolByName

from plone.formwidget.autocomplete import AutocompleteMultiFieldWidget
from plone.z3cform.textlines import TextLinesFieldWidget

from zope.interface import invariant, Invalid

from plone.app.textfield.value import RichTextValue
from AccessControl.interfaces import IRoleManager
from DateTime import DateTime
from plone.indexer import indexer
import datetime

from zope.schema.interfaces import IVocabularyFactory

from Acquisition import aq_inner, aq_parent
from Products.CMFCore.utils import getToolByName
from cycle import ICycle
from Products.CMFCore.interfaces import IFolderish
from zope.security import checkPermission

class ProfsVocabulary(object):
    grok.implements(IVocabularyFactory)
    
    def __call__(self, context):
        acl_users = getToolByName(context, 'acl_users')
        membership = getToolByName(context, 'portal_membership') 
        
        terms = []
        users = acl_users.getUserNames()
        if users is not None:
            for member_id in users:
                user = acl_users.getUserById(member_id)
                if user is not None:
                    member_name = user.getProperty('fullname') or member_id
                    terms.append(SimpleVocabulary.createTerm(member_id, str(member_id), member_name))
                else:
                    user = membership.getMemberById(member_id)
                    if user is not None:
                        member_name = user.getProperty('fullname') or member_id
                        terms.append(SimpleVocabulary.createTerm(member_id, str(member_id), member_name))
                    else:
                        member_name = member_id
                        terms.append(SimpleVocabulary.createTerm(member_id, str(member_id), member_name))
                        
        return SimpleVocabulary(terms)

grok.global_utility(ProfsVocabulary, name=u"ageliaco.rd.Profs")

class GroupMembers(object):
    """Context source binder to provide a vocabulary of users in a given
    group.
    """
    
    grok.implements(IContextSourceBinder)
    
    def __init__(self, group_name):
        self.group_name = group_name
    
    def __call__(self, context):
        acl_users = getToolByName(context, 'acl_users')
        group = acl_users.getGroupById(self.group_name)
        terms = []
    
        if group is not None:
            for member_id in group.getMemberIds():
                user = acl_users.getUserById(member_id)
                if user is not None:
                    member_name = user.getProperty('fullname') or member_id
                    terms.append(SimpleVocabulary.createTerm(member_id, str(member_id), member_name))
            
        return SimpleVocabulary(terms)    

class IProjet(form.Schema):
    """
    Projet RD
    """
    start = schema.TextLine(
            title=_(u"Année"),
            description=_(u"L'année à laquelle le projet a commencé ou devrait commencer"),
            required=True,
        )

    duration = schema.Int(
            title=_(u"Durée"),
            description=_(u"Durée (en années) du projet, prévue ou effective"),
            required=True,
        )
    
    num = schema.Int(
            title=_(u"Numéro"),
            description=_(u"Numéro du projet"),
            required=True,
        )

    presentation = RichText(
            title=_(u"Présentation"),
            description=_(u"Présentation synthétique du projet (présentation publiée)"),
            required=True,
        )    


class View(grok.View):
    grok.context(IProjet)
    grok.require('zope2.View')
    
    def canRequestReview(self):
        return checkPermission('cmf.RequestReview', self.context)

    def logo_url(self):
        context = aq_inner(self.context)
        portal_url = getToolByName(context, 'portal_url')
        if 'logo.png' in context.keys():
            return context.absolute_url() + '/logo.png'
        return portal_url + '/++resource++ageliaco.rd/screens.png'      

    def noCycle(self):
        context = aq_inner(self.context)
        print context.id
        admin = 'admin_' + context.id
        if admin in context.objectIds():
            administration = context[admin]
            if len(administration.objectIds())>0:
                print administration.objectIds()
                return False
            else:
                return True
        return True
        
    def new_cycle_url(self):
        context = aq_inner(self.context)
        print context.id
        admid = 'admin_' + context.id 
        url = context.absolute_url() + '/' + admid + '/++add++ageliaco.rd.cycle'
        return url 
        
    def cycles(self):
        """Return a catalog search result of issues to show
        """
        
        context = aq_inner(self.context)
        #catalog = getToolByName(self.context, 'portal_catalog')
        #object = context
        #return catalog(object_provides= ICycle.__identifier__,
        #               path={'query': '/'.join(context.getPhysicalPath()), 'depth': 1},
        #               sort_on="modified", sort_order="reverse")        
        print context.id
        admin = 'admin_' + context.id
        if admin in context.objectIds():
            administration = context[admin]
            for cycle in administration.objectValues():
                print cycle.title_or_id()
            return administration.objectValues()
        return []

@indexer(IProjet)
def startIndexer(obj):
    if obj.start is None:
        return None
    adate = datetime.date(int(obj.start.split('-')[0]),9,1)
    return DateTime(adate.isoformat())
grok.global_adapter(startIndexer, name="start")

@indexer(IProjet)
def endIndexer(obj):
    if obj.duration is None:
        return None
    adate = datetime.date(int(obj.start.split('-')[0])+obj.duration,9,1)
    return DateTime(adate.isoformat())
grok.global_adapter(endIndexer, name="end")



@form.default_value(field=IProjet['start'])
def startDefaultValue(data):
    # To get hold of the folder, do: context = data.context
    return str(datetime.datetime.today().year)

@form.default_value(field=IProjet['duration'])
def durationDefaultValue(data):
    # To get hold of the folder, do: context = data.context
    return 1
    
@form.default_value(field=IProjet['presentation'])
def presentationDefaultValue(data):
    # To get hold of the folder, do: context = data.context
    return RichTextValue(
            raw=canvas
            )

# @grok.subscribe(IProjet, IObjectAddedEvent)
# @grok.subscribe(IProjet, IObjectModifiedEvent)
# def createGroup(projet, event):
#     print "=== Group creation ==="
#     acl_users = getToolByName(projet, 'acl_users')
#     mail_host = getToolByName(projet, 'MailHost')
#     portal_url = getToolByName(projet, 'portal_url')
#     
#     portal = portal_url.getPortalObject()
#     sender = portal.getProperty('email_from_address')
# 
#     gr = portal.portal_groups
#     
#     group_id = projet.id
#     if not group_id in gr.getGroupIds():
#         gr.addGroup(group_id)
#     
#     for member in projet.contributor:
#         gtool = getToolByName(portal, "portal_groups", None)
#         user_groups = gtool.getGroupsByUserId(member)
#         print "user groups for member %s : "%member, user_groups
#         if group_id not in user_groups:
#             print "adding group ", group_id
#             gr.addPrincipalToGroup(member, group_id)
#             
#      
#     #Add local roles to a group
#     if IRoleManager.providedBy(projet):
#         print "adding roles (contributor and Editor) to ", group_id 
#         projet.manage_addLocalRoles(group_id, ['Contributor','Editor'])
#     
# 
#     return
    
@grok.subscribe(IProjet, IObjectAddedEvent)
def setCycles(projet, event):
    admid = 'admin_%s'%projet.id
    try:
        cycles = projet[admid]
    except KeyError: 
        projet.invokeFactory("ageliaco.rd.cycles", id=admid, title='Administration')
        cycles = projet[admid]
    
    #projet.setContributors(projet.contributor)
    #request.response.redirect(cycles.absolute_url() + '++add++ageliaco.rd.cycle')
    return #request.response.redirect(cycles.absolute_url() + '++add++ageliaco.rd.cycle')

@grok.subscribe(IProjet, IObjectAddedEvent)
def setRealisation(projet, event):
    admid = 'realisation'
    try:
        cycles = projet[admid]
    except KeyError: 
        rea = projet.invokeFactory("Folder", id=admid, title=u'Réalisation')
        #projet[admid] = rea
    
    #projet.setContributors(projet.contributor)
    #request.response.redirect(cycles.absolute_url() + '++add++ageliaco.rd.cycle')
    return #request.response.redirect(cycles.absolute_url() + '++add++ageliaco.rd.cycle')


class View(grok.View):
    grok.context(IProjet)
    grok.require('zope2.View')    
    #template = grok.PageTemplateFile('projet_templates/view.pt')

    
    def canRequestReview(self):
        return checkPermission('cmf.RequestReview', self.context)
        
    def canAddContent(self):
        return checkPermission('cmf.AddPortalContent', self.context)
        
    def canModifyContent(self):
        return checkPermission('cmf.ModifyPortalContent', self.context)
        
        
    def cycles_obj(self):
        #return a list of actual cycle objects
        context = aq_inner(self.context)
        l = []
        for id, objet in context.contentItems():
            print id, object
            if id=='admin_' + context.id :
                for i, obj in objet.contentItems():
                    print obj.portal_type
                    if obj.portal_type == 'ageliaco.rd.cycle':
                        l.append(obj)
        
        return l
        
    
    def admin_url(self):
        context = aq_inner(self.context)
        admid = 'admin_' + context.id
        if admid in context.keys():
            return context[admid].absolute_url()
        return ''

    def contributeur(self,auteur):
        context = aq_inner(self.context)
        admid = 'admin_' + context.id
        if admid in context.keys():
            parent = context[admid]
        
            if auteur in parent.keys():
                return parent[auteur]
        return None
        
    

    def cycles(self):
        #return a list with all the cycles for this projet
        context = aq_inner(self.context)
        catalog = getToolByName(self.context, 'portal_catalog')
        try:
            objet = context['admin_' + context.id]
            return catalog(object_provides= ICycle.__identifier__,
                           path={'query': object.absolute_url(), 'depth': 1},
                           sort_on="modified", sort_order="reverse")        
            
        except:
            return []
        #log( 'cycle : ' + object.getPath())
        #log( wf_state + " state chosen")

# class AddForm(dexterity.AddForm):
#     grok.name('ageliaco.rd.projet')
#     grok.context(IProjet)
#     def update(self):
#         super(AddForm,self).update()
#         url = self.context.absolute_url() + '++add++ageliaco.rd.cycle'
#         #self.request.response.redirect(cycles.absolute_url() + '++add++ageliaco.rd.cycle')
#         self.request.response.redirect(url)